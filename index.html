const videoSelect = document.getElementById("videoSelect");
let stream = null;

// Listar cámaras disponibles
async function listarCamaras() {
    try {
        // Pedimos permiso primero para poder obtener labels
        const tempStream = await navigator.mediaDevices.getUserMedia({ video: true });
        tempStream.getTracks().forEach(t => t.stop());

        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(d => d.kind === "videoinput");

        videoSelect.innerHTML = "";
        videoDevices.forEach((device, i) => {
            const opt = document.createElement("option");
            opt.value = device.deviceId;
            opt.textContent = device.label || `Cámara ${i+1}`;
            videoSelect.appendChild(opt);
        });

        if (videoDevices.length > 0) videoSelect.value = videoDevices[0].deviceId;
    } catch (err) {
        console.error("No se pudo listar las cámaras:", err);
        alert("Error accediendo a la cámara: " + err.message);
    }
}

// Iniciar cámara seleccionada
async function startCamera(deviceId = null) {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        camVideo.srcObject = null;
        stream = null;
        camBtn.style.background = "";
    }

    const constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: true };

    try {
        stream = await navigator.mediaDevices.getUserMedia(constraints);
        camVideo.srcObject = stream;
        camBtn.style.background = "orange";
    } catch (err) {
        alert("No se pudo iniciar la cámara: " + err.message);
        camBtn.style.background = "";
    }
}

// Cambiar cámara desde el selector
videoSelect.onchange = () => startCamera(videoSelect.value);

// Botón para encender/apagar
camBtn.onclick = () => {
    if (stream) {
        stream.getTracks().forEach(t => t.stop());
        camVideo.srcObject = null;
        stream = null;
        camBtn.style.background = "";
    } else {
        startCamera(videoSelect.value);
    }
};

// Inicializar al cargar
listarCamaras();
